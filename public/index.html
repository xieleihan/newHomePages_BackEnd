<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™æ€èµ„æºç®¡ç†å™¨</title>
    <link rel="stylesheet" href="./static/css/style.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ“ é™æ€èµ„æºç®¡ç†å™¨</h1>
        
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading" class="loading">æ­£åœ¨åŠ è½½èµ„æº</div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div id="stats" class="stats hidden">
            <h2>ğŸ“Š èµ„æºç»Ÿè®¡</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="total-files">0</span>
                    <span class="stat-label">æ€»æ–‡ä»¶æ•°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="total-size">0</span>
                    <span class="stat-label">æ€»å¤§å°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="file-types">0</span>
                    <span class="stat-label">æ–‡ä»¶ç±»å‹</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="image-count">0</span>
                    <span class="stat-label">å›¾ç‰‡æ–‡ä»¶</span>
                </div>
            </div>
        </div>
        
        <!-- å›¾è¡¨å®¹å™¨ -->
        <div id="chart-container" class="chart-container hidden">
            <h2>ğŸŒ¹ èµ„æºåˆ†å¸ƒå›¾ (å—ä¸æ ¼å°”ç«ç‘°å›¾)</h2>
            <div id="chart"></div>
        </div>
        
        <!-- èµ„æºåˆ—è¡¨ -->
        <div id="resource-section" class="resource-section hidden">
            <h2>ğŸ“‚ èµ„æºåˆ—è¡¨</h2>
            
            <!-- æ ‡ç­¾é¡µ -->
            <div class="resource-tabs">
                <button class="tab-btn active" data-type="all">å…¨éƒ¨</button>
                <button class="tab-btn" data-type="images">å›¾ç‰‡</button>
                <button class="tab-btn" data-type="js">JavaScript</button>
                <button class="tab-btn" data-type="css">æ ·å¼è¡¨</button>
                <button class="tab-btn" data-type="font">å­—ä½“</button>
                <button class="tab-btn" data-type="other">å…¶ä»–</button>
            </div>
            
            <!-- èµ„æºç½‘æ ¼ -->
            <div id="resource-grid" class="resource-grid"></div>
        </div>
    </div>

    <script src="./static/js/jquery-3.7.1.min.js"></script>
    <script src="./static/js/echarts.min.js"></script>
    <script>
        $(document).ready(function() {
            let allFiles = [];
            let currentFilter = 'all';
            
            // æ–‡ä»¶ç±»å‹é…ç½®
            const fileTypeConfig = {
                images: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg', 'ico'],
                js: ['js', 'mjs', 'jsx'],
                css: ['css', 'scss', 'sass', 'less'],
                font: ['woff', 'woff2', 'ttf', 'otf', 'eot'],
                other: []
            };
            
            // æ–‡ä»¶å›¾æ ‡æ˜ å°„
            const fileIcons = {
                js: 'ğŸ“„',
                css: 'ğŸ¨',
                font: 'ğŸ”¤',
                images: 'ğŸ–¼ï¸',
                other: 'ğŸ“„'
            };
            
            // åŠ è½½é™æ€æ–‡ä»¶
            loadStaticFiles();
            
            function loadStaticFiles() {
                $.ajax({
                    url: '/api/static-files',
                    method: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if (response.code === 200) {
                            allFiles = response.data;
                            processFilesData();
                            hideLoading();
                            showContent();
                            renderChart();
                            renderResourceList();
                        } else {
                            showError('åŠ è½½å¤±è´¥: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        showError('ç½‘ç»œé”™è¯¯: ' + error);
                    }
                });
            }
            
            function processFilesData() {
                // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                const totalFiles = allFiles.length;
                const totalSize = allFiles.reduce((sum, file) => sum + file.size, 0);
                const fileTypes = new Set(allFiles.map(file => file.ext)).size;
                const imageCount = allFiles.filter(file => 
                    fileTypeConfig.images.includes(file.ext)).length;
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                $('#total-files').text(totalFiles);
                $('#total-size').text(formatBytes(totalSize));
                $('#file-types').text(fileTypes);
                $('#image-count').text(imageCount);
            }
            
            function renderChart() {
                const chart = echarts.init(document.getElementById('chart'));
                
                // ç»Ÿè®¡æ–‡ä»¶ç±»å‹åˆ†å¸ƒ
                const typeCount = {};
                allFiles.forEach(file => {
                    const type = getFileType(file.ext);
                    typeCount[type] = (typeCount[type] || 0) + 1;
                });
                
                const data = Object.keys(typeCount).map(type => ({
                    value: typeCount[type],
                    name: getTypeDisplayName(type)
                }));
                
                const option = {
                    title: {
                        text: 'æ–‡ä»¶ç±»å‹åˆ†å¸ƒ',
                        subtext: 'å—ä¸æ ¼å°”ç«ç‘°å›¾',
                        left: 'center',
                        textStyle: {
                            fontSize: 18,
                            fontWeight: 'bold'
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    legend: {
                        bottom: '5%',
                        left: 'center'
                    },
                    series: [{
                        name: 'æ–‡ä»¶ç±»å‹',
                        type: 'pie',
                        radius: [30, 140],
                        center: ['50%', '50%'],
                        roseType: 'area',
                        itemStyle: {
                            borderRadius: 8
                        },
                        data: data,
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        },
                        animationType: 'scale',
                        animationEasing: 'elasticOut',
                        animationDelay: function (idx) {
                            return Math.random() * 200;
                        }
                    }]
                };
                
                chart.setOption(option);
                
                // å“åº”å¼
                window.addEventListener('resize', function() {
                    chart.resize();
                });
            }
            
            function renderResourceList() {
                const filteredFiles = filterFiles(allFiles, currentFilter);
                const grid = $('#resource-grid');
                grid.empty();
                
                if (filteredFiles.length === 0) {
                    grid.html('<div style="text-align: center; padding: 40px; color: #666;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–‡ä»¶</div>');
                    return;
                }
                
                filteredFiles.forEach(file => {
                    const fileType = getFileType(file.ext);
                    const isImage = fileTypeConfig.images.includes(file.ext);
                    
                    let previewHtml = '';
                    if (isImage) {
                        previewHtml = `<img class="resource-img" src="./static${file.path}" alt="${file.name}" loading="lazy">`;
                    } else {
                        previewHtml = `<div class="resource-icon">${fileIcons[fileType] || fileIcons.other}</div>`;
                    }
                    
                    const itemHtml = `
                        <div class="resource-item">
                            <div class="resource-preview">
                                ${previewHtml}
                            </div>
                            <div class="resource-info">
                                <div class="resource-name">${file.name}</div>
                                <div class="resource-details">
                                    ç±»å‹: ${file.ext.toUpperCase()} | å¤§å°: ${file.sizeFormatted}
                                </div>
                                <div class="resource-actions">
                                    ${isImage ? 
                                        `<a href="./static${file.path}" target="_blank" class="btn btn-primary">é¢„è§ˆ</a>` :
                                        `<a href="./static${file.path}" download class="btn btn-primary">ä¸‹è½½</a>`
                                    }
                                    <a href="./static${file.path}" target="_blank" class="btn btn-secondary">é“¾æ¥</a>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    grid.append(itemHtml);
                });
            }
            
            function filterFiles(files, type) {
                if (type === 'all') return files;
                
                if (fileTypeConfig[type]) {
                    return files.filter(file => fileTypeConfig[type].includes(file.ext));
                }
                
                return files.filter(file => getFileType(file.ext) === 'other');
            }
            
            function getFileType(ext) {
                for (const [type, extensions] of Object.entries(fileTypeConfig)) {
                    if (extensions.includes(ext)) {
                        return type;
                    }
                }
                return 'other';
            }
            
            function getTypeDisplayName(type) {
                const names = {
                    images: 'å›¾ç‰‡æ–‡ä»¶',
                    js: 'JavaScript',
                    css: 'æ ·å¼è¡¨',
                    font: 'å­—ä½“æ–‡ä»¶',
                    other: 'å…¶ä»–æ–‡ä»¶'
                };
                return names[type] || type;
            }
            
            function formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            function hideLoading() {
                $('#loading').addClass('hidden');
            }
            
            function showContent() {
                $('#stats').removeClass('hidden');
                $('#chart-container').removeClass('hidden');
                $('#resource-section').removeClass('hidden');
            }
            
            function showError(message) {
                $('#loading').html(`<div style="color: #ff6b6b;">âŒ ${message}</div>`);
            }
            
            // æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            $('.tab-btn').click(function() {
                const type = $(this).data('type');
                currentFilter = type;
                
                $('.tab-btn').removeClass('active');
                $(this).addClass('active');
                
                renderResourceList();
            });
            
            // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
            $(document).on('error', '.resource-img', function() {
                $(this).closest('.resource-preview').html('<div class="resource-icon">âŒ</div>');
            });
        });
    </script>
</body>
</html>